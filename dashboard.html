<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AgriDetect - Dashboard</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <!-- NAVBAR -->
  <nav class="navbar">
    <div class="container">
      <div class="logo">
        <h1>üåæ AgriDetect</h1>
      </div>
      <ul class="nav-menu">
        <li><a href="index.html">D√©tection</a></li>
        <li><a href="chat.html">Chat Bot</a></li>
        <li><a href="dashboard.html" class="active">Dashboard</a></li>
      </ul>
    </div>
  </nav>

  <main class="container">
    <section class="hero">
      <h2>üìä Tableau de bord AgriDetect</h2>
      <p>Statistiques et maladies d√©tect√©es via l'API</p>
    </section>

    <!-- tuiles de statistiques -->
    <section class="stats-grid" style="margin-bottom: 1.5rem;">
      <div class="stat-card">
        <div class="stat-icon">üìà</div>
        <div class="stat-content">
          <h3 id="totalDetections">--</h3>
          <p>D√©tections totales</p>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">üë•</div>
        <div class="stat-content">
          <h3 id="activeUsers">--</h3>
          <p>Utilisateurs actifs</p>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">ü¶†</div>
        <div class="stat-content">
          <h3 id="diseaseTypes">--</h3>
          <p>Types de maladies</p>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">‚úÖ</div>
        <div class="stat-content">
          <h3 id="successRate">--</h3>
          <p>Taux de r√©ussite</p>
        </div>
      </div>
    </section>

    <!-- 2 colonnes : maladies courantes et top maladies -->
    <section class="dashboard-content">
      <div class="dashboard-card">
        <h3>üåæ Maladies courantes</h3>
        <div class="diseases-list" id="diseasesList">
          <div class="loading-small">Chargement‚Ä¶</div>
        </div>
      </div>

      <div class="dashboard-card">
        <h3>üìà Maladies les plus d√©tect√©es</h3>
        <div class="chart-container" id="topDiseases">
          <div class="loading-small">Chargement‚Ä¶</div>
        </div>
      </div>
    </section>
  </main>

  <footer>
    <div class="container">
      <p>&copy; 2025 AgriDetect ‚Äì API v1.1.0</p>
    </div>
  </footer>

  <script>
    async function loadDashboard() {
      // URL de ton API FastAPI
      const API_URL = "http://192.168.1.10:8000/api/v1/statistics/dashboard";

      const diseasesListEl = document.getElementById("diseasesList");
      const topDiseasesEl = document.getElementById("topDiseases");

      try {
        const res = await fetch(API_URL);
        if (!res.ok) {
          throw new Error("HTTP " + res.status);
        }
        const data = await res.json();
        console.log("üìä Dashboard data:", data);

        // ‚úÖ Remplir les tuiles de statistiques
        document.getElementById("totalDetections").textContent = data.total_detections ?? "--";
        document.getElementById("activeUsers").textContent = data.active_users ?? "--";
        document.getElementById("diseaseTypes").textContent = data.diseases_detected ?? "--";
        document.getElementById("successRate").textContent = data.success_rate ? data.success_rate.toFixed(1) + "%" : "--";

        // ‚úÖ Colonne 1 : Maladies courantes
        diseasesListEl.innerHTML = "";
        const commonDiseases = data.common_diseases || [];

        if (!commonDiseases.length) {
          diseasesListEl.innerHTML = "<p style='color: #999;'>Aucune donn√©e disponible pour le moment.</p>";
        } else {
          commonDiseases.forEach(item => {
            const div = document.createElement("div");
            div.className = "disease-item";
            div.innerHTML = `
              <span class="disease-name">${item.name}</span>
              <span class="disease-count">${item.count} d√©tections</span>
            `;
            diseasesListEl.appendChild(div);
          });
        }

        // ‚úÖ Colonne 2 : Maladies les plus d√©tect√©es (graphique en barres)
        topDiseasesEl.innerHTML = "";
        const topDiseases = data.top_diseases || [];

        if (!topDiseases.length) {
          topDiseasesEl.innerHTML = "<p style='color: #999;'>Pas de donn√©es de d√©tection.</p>";
        } else {
          topDiseases.forEach(item => {
            // Calculer le pourcentage
            const percent = data.total_detections && data.total_detections > 0
              ? Math.min(100, Math.round((item.count / data.total_detections) * 100))
              : 0;

            const wrap = document.createElement("div");
            wrap.className = "chart-bar";
            wrap.innerHTML = `
              <div class="chart-label">
                <span style="font-weight: bold;">${item.name}</span>
                <span style="color: #666;">${item.count} d√©tections (${percent}%)</span>
              </div>
              <div class="progress-bar">
                <div class="progress-fill" style="width:${percent}%;"></div>
              </div>
            `;
            topDiseasesEl.appendChild(wrap);
          });
        }

      } catch (err) {
        console.error("‚ùå Erreur lors du chargement du dashboard:", err);
        diseasesListEl.innerHTML = "<p style='color: red;'>‚ö†Ô∏è Impossible de charger les donn√©es. V√©rifie que FastAPI tourne sur http://127.0.0.1:8000</p>";
        topDiseasesEl.innerHTML = "<p style='color: red;'>‚ö†Ô∏è Erreur de connexion √† l'API.</p>";
      }
    }

    // Charger le dashboard au chargement de la page
    document.addEventListener("DOMContentLoaded", loadDashboard);

    // Optionnel : rafra√Æchir les donn√©es toutes les 30 secondes
    setInterval(loadDashboard, 30000);
  </script>
</body>
</html>
